{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="max-w-4xl mx-auto py-10 px-4">
  <h1 class="text-3xl font-bold text-center mb-6">{% trans "Suscríbete a Sillage Premium" %}</h1>
  
  
  <div class="bg-[var(--block)] rounded-2xl shadow-lg p-8 mb-10">
    <div class="text-center mb-8">
      <h2 class="text-2xl font-semibold text-[var(--accent)]">{% trans "Plan Mensual" %}</h2>
      <div class="text-4xl font-bold my-4">
        <span>{{ precio_mensual }}</span>
        <span class="text-sm font-normal">{{ moneda }}/{% trans "mes" %}</span>
      </div>
      <p class="text-[var(--text-muted)] mb-6">{% trans "Renovación automática - Cancela cuando quieras" %}</p>
    </div>
    
    <div class="space-y-4 mb-8">
      <div class="flex items-start">
        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
        <p>{% trans "Recomendaciones personalizadas ilimitadas" %}</p>
      </div>
      <div class="flex items-start">
        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
        <p>{% trans "Análisis climático y contextual" %}</p>
      </div>
      <div class="flex items-start">
        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
        <p>{% trans "Hasta 100 perfumes en tu colección" %}</p>
      </div>
      <div class="flex items-start">
        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
        <p>{% trans "30 consultas mensuales" %}</p>
      </div>
    </div>
    
    <!-- Contenedor del botón PayPal -->
    <div id="paypal-button-container" class="mt-6"></div>
    <div id="paypal-error" class="mt-4 text-center text-red-500 hidden"></div>
    
    <p class="text-center text-xs text-[var(--text-muted)] mt-6">
      {% trans "Al suscribirte, aceptas nuestros términos y condiciones" %}
    </p>
  </div>
</div>

<!-- Verificación de client_id -->
<script>
  // Función para reportar errores
  function reportError(message) {
    console.error("PayPal Error:", message);
    const errorElement = document.getElementById('paypal-error');
    if (errorElement) {
      errorElement.classList.remove('hidden');
      errorElement.textContent = message;
    }
  }
  
  // Verificar si el client_id está presente
  const clientId = "{{ client_id }}";
  if (!clientId || clientId === '') {
    reportError('Error: PayPal Client ID no configurado. Contacta al administrador.');
  } else {
    console.log("Client ID configurado correctamente:", clientId.substring(0, 10) + "...");
  }
</script>

<!-- Solo cargar el SDK si client_id no está vacío -->
{% if client_id %}
<script src="https://www.paypal.com/sdk/js?client-id={{ client_id }}&vault=true&intent=subscription&components=buttons"></script>
<script>
  // Verificar que el SDK se cargó correctamente
  window.addEventListener('load', function() {
    if (typeof paypal === 'undefined') {
      reportError('Error: No se pudo cargar el SDK de PayPal');
      return;
    }
    
    console.log("SDK de PayPal cargado correctamente");
    
    // Variable para controlar si ya estamos procesando un pago
    let isProcessingPayment = false;
    
    // Renderizar el botón de PayPal
    paypal.Buttons({
      style: {
        layout: 'vertical',
        shape: 'rect',
        label: 'subscribe'
      },
      
      // Crear la suscripción con el plan predefinido
      createSubscription: function(data, actions) {
        console.log("Iniciando creación de suscripción...");
        
        // Configuración para evitar popup problemático
        return actions.subscription.create({
          'plan_id': '{{ plan_id }}',
          'application_context': {
            'shipping_preference': 'NO_SHIPPING',
            'user_action': 'CONTINUE',
            'return_url': window.location.href + '?success=true',
            'cancel_url': window.location.href + '?success=false'
          }
        });
      },
      
      // Al aprobar el pago
      onApprove: function(data, actions) {
        console.log("Pago aprobado. Subscription ID:", data.subscriptionID);
        
        // Evitar procesamiento múltiple
        if (isProcessingPayment) {
          console.log("Ya hay un procesamiento en curso.");
          return;
        }
        
        isProcessingPayment = true;
        
        // Mostrar indicador de carga
        document.getElementById('paypal-button-container').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin text-2xl text-[var(--accent)]"></i><p class="mt-2">{% trans "Procesando suscripción..." %}</p></div>';
        
        // Enviar el subscriptionID al backend
        return fetch("{% url 'administrador:confirmar_suscripcion' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ 
            subscriptionID: data.subscriptionID 
          })
        })
        .then(function(response) {
          console.log("Respuesta del servidor:", response.status);
          return response.json();
        })
        .then(function(data) {
          if (data.success) {
            console.log("Suscripción confirmada con éxito");
            // Redireccionar al perfil
            window.location.href = "{% url 'users:perfil' %}";
          } else {
            console.error("Error en confirmación:", data.error);
            isProcessingPayment = false;
            // Mostrar error
            document.getElementById('paypal-button-container').innerHTML = `<div class="text-center text-red-500"><p>Error: ${data.error || 'Ocurrió un error al procesar la suscripción'}</p><p class="mt-2">Por favor, inténtalo de nuevo.</p></div>`;
          }
        })
        .catch(function(error) {
          console.error('Error de conexión:', error);
          isProcessingPayment = false;
          document.getElementById('paypal-button-container').innerHTML = '<div class="text-center text-red-500"><p>{% trans "Error de conexión. Por favor, inténtalo de nuevo." %}</p></div>';
        });
      },
      
      // Si el usuario cancela
      onCancel: function(data) {
        console.log('Suscripción cancelada por el usuario');
      },
      
      // Si hay un error
      onError: function(err) {
        console.error('Error detallado en PayPal:', err);
        reportError('{% trans "Error de PayPal. Por favor, inténtalo de nuevo más tarde." %}');
      }
    }).render('#paypal-button-container')
    .catch(function(err) {
      console.error('Error al renderizar botones:', err);
      reportError('Error al inicializar el botón de PayPal: ' + err.message);
    });
    
    // Verificar estado de retorno de pago
    const urlParams = new URLSearchParams(window.location.search);
    const success = urlParams.get('success');
    
    if (success === 'true') {
      // Mostrar mensaje de éxito temporal
      reportError('Procesando tu suscripción. Si no eres redirigido en unos segundos, por favor contacta a soporte.');
    } else if (success === 'false') {
      reportError('La suscripción fue cancelada. Puedes intentarlo nuevamente cuando quieras.');
    }
  });
</script>
{% else %}
<script>
  reportError('Error: No se ha configurado el Client ID de PayPal');
</script>
{% endif %}
{% endblock %}