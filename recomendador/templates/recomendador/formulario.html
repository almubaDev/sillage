{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="text-center py-10">
  <h1 class="text-3xl font-bold mb-4">{% trans "Bienvenido a tu recomendador de perfumes" %}</h1>
  <p class="text-sm text-gray-400 mb-6">{% trans "Obtén la mejor sugerencia según tu ocasión, vestimenta y contexto." %}</p>
  <button onclick="document.getElementById('modal-recomendar').showModal()"
          class="btn-accent px-6 py-3 rounded-full text-sm font-semibold shadow hover:scale-105 transition">
    {% trans "Recomendar" %}
  </button>
</div>

<!-- Modal multistep -->
<dialog id="modal-recomendar" class="relative max-w-2xl w-full rounded-xl shadow-xl backdrop:bg-black/40">
  <form method="post" class="bg-[var(--bg)] text-[var(--text)] p-6 space-y-6" enctype="multipart/form-data" onsubmit="return mostrarSpinner();">
    {% csrf_token %}

    <!-- Paso 1: Detalles del evento -->
    <div id="paso1" class="step-content space-y-4">
      <h2 class="text-xl font-bold mb-2">{% trans "Paso 1: Detalles del evento" %}</h2>
    
      <div>
        <label for="{{ form.fecha_evento.id_for_label }}" class="font-semibold">{% trans "Fecha del evento" %}</label>
        {{ form.fecha_evento }}
        {{ form.fecha_evento.errors }}
      </div>
    
      <div>
        <label for="{{ form.hora_evento.id_for_label }}" class="font-semibold">{% trans "Hora del evento" %}</label>
        {{ form.hora_evento }}
        {{ form.hora_evento.errors }}
      </div>
    
      <div>
        <label for="{{ form.ocasion.id_for_label }}" class="font-semibold">{% trans "Ocasión" %}</label>
        {{ form.ocasion }}
        {{ form.ocasion.errors }}
      </div>
    
      <div>
        <label for="{{ form.expectativa.id_for_label }}" class="font-semibold">{% trans "Expectativa emocional" %}</label>
        {{ form.expectativa }}
        {{ form.expectativa.errors }}
      </div>
    
      <div>
        <label for="{{ form.vestimenta.id_for_label }}" class="font-semibold">{% trans "Vestimenta" %}</label>
        {{ form.vestimenta }}
        {{ form.vestimenta.errors }}
      </div>
    
      <div>
        <label for="{{ form.lugar_tipo.id_for_label }}" class="font-semibold">{% trans "Tipo de lugar" %}</label>
        {{ form.lugar_tipo }}
        {{ form.lugar_tipo.errors }}
      </div>
    
      <div>
        <label for="{{ form.lugar_descripcion.id_for_label }}" class="font-semibold">{% trans "Descripción del lugar" %}</label>
        {{ form.lugar_descripcion }}
        {{ form.lugar_descripcion.errors }}
      </div>
    
      <div class="flex justify-between items-center pt-4">
        <button type="button"
                onclick="document.getElementById('modal-recomendar').close();"
                class="text-sm underline text-gray-300 hover:text-red-500 transition">
          {% trans "Cancelar" %}
        </button>
        <button type="button"
                onclick="mostrarPaso(2)"
                class="bg-[var(--accent)] text-[var(--bg)] px-4 py-2 rounded hover:brightness-110">
          {% trans "Continuar" %}
        </button>
      </div>
    </div>
    
    <!-- Paso 2 -->
    <div id="paso2" class="step-content space-y-4 hidden">
      <h2 class="text-xl font-bold mb-2">{% trans "Paso 2: Selecciona la ubicación del evento" %}</h2>

      <div class="flex gap-2">
        <input id="autocomplete" type="text" placeholder="{% trans 'Buscar dirección...' %}"
               class="flex-grow border px-3 py-2 rounded shadow" />
        <button type="button" onclick="buscarLugar()"
                class="bg-[var(--accent)] text-[var(--bg)] px-4 py-2 rounded hover:brightness-110">
          {% trans "Buscar" %}
        </button>
      </div>

      <div id="map" class="w-full h-64 rounded shadow border border-[var(--accent)]"></div>

      {{ form.latitud }}{{ form.longitud }}{{ form.lugar_nombre }}

      <div class="flex justify-between pt-4">
        <button type="button" onclick="mostrarPaso(1)" class="underline text-sm text-gray-400">
          {% trans "Volver" %}
        </button>
        <button type="submit" id="btnRecomendar" class="bg-[var(--accent)] text-[var(--bg)] px-4 py-2 rounded hover:brightness-110" disabled>
          {% trans "Recomendar" %}
        </button>
      </div>
    </div>
  </form>

  <!-- Indicador de carga -->
  <div id="cargando-spinner" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-50 rounded-xl">
    <div class="border-4 border-[var(--accent)] border-t-transparent rounded-full w-12 h-12 animate-spin"></div>
  </div>
</dialog>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYW7kK_nRl4IHm8P5_MPqPDVPbMl7J-n0&libraries=places&language=es" async defer></script>

<script>
let map, marker, geocoder;

function initMap() {
  const centro = { lat: -33.45, lng: -70.66 };
  map = new google.maps.Map(document.getElementById("map"), {
    center: centro,
    zoom: 13,
  });

  marker = new google.maps.Marker({
    map: map,
    draggable: true,
    visible: false,
  });

  geocoder = new google.maps.Geocoder();

  marker.addListener("dragend", () => {
    const pos = marker.getPosition();
    actualizarInputs(pos.lat(), pos.lng());
    obtenerDireccion(pos.lat(), pos.lng());
    activarBoton();
  });
}

function buscarLugar() {
  const direccion = document.getElementById("autocomplete").value;
  geocoder.geocode({ address: direccion }, (results, status) => {
    if (status === "OK" && results[0]) {
      const location = results[0].geometry.location;
      map.setCenter(location);
      map.setZoom(15);
      marker.setPosition(location);
      marker.setVisible(true);
      actualizarInputs(location.lat(), location.lng());
      obtenerDireccion(location.lat(), location.lng());
      activarBoton();
    } else {
      alert("No se pudo encontrar la dirección.");
    }
  });
}

function actualizarInputs(lat, lng) {
  document.getElementById("id_latitud").value = lat.toFixed(6);
  document.getElementById("id_longitud").value = lng.toFixed(6);
}

function obtenerDireccion(lat, lng) {
  fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=AIzaSyBYW7kK_nRl4IHm8P5_MPqPDVPbMl7J-n0&language=es`)
    .then(res => res.json())
    .then(data => {
      if (data.results && data.results[0]) {
        document.getElementById("id_lugar_nombre").value = data.results[0].formatted_address;
      }
    });
}

function activarBoton() {
  document.getElementById("btnRecomendar").disabled = false;
}

function mostrarPaso(n) {
  document.querySelectorAll(".step-content").forEach(e => e.classList.add("hidden"));
  document.getElementById("paso" + n).classList.remove("hidden");
}

function mostrarSpinner() {
  const lat = document.getElementById("id_latitud").value;
  const lon = document.getElementById("id_longitud").value;
  if (lat && lon) {
    document.getElementById("cargando-spinner").classList.remove("hidden");
    return true;
  }
  return false;
}

document.addEventListener("DOMContentLoaded", () => {
  if (window.google && google.maps) {
    initMap();
  } else {
    window.initMap = initMap;
  }
  mostrarPaso(1);
});
</script>
{% endblock %}
